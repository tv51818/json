<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易接口管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600">
                <i class="fa fa-link mr-2"></i>接口管理系统
            </h1>
            <div id="userInfo" class="flex items-center">
                <button id="logoutBtn" class="text-red-500 hidden ml-4" onclick="logout()">
                    <i class="fa fa-sign-out mr-1"></i>退出
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- 登录/注册区域 -->
        <div id="authArea" class="mb-6">
            <div class="bg-white p-6 rounded shadow">
                <h3 class="text-lg font-semibold mb-4 text-center">用户认证</h3>
                <input type="text" id="username" placeholder="用户名" class="border p-2 w-full mb-3 rounded">
                <input type="password" id="password" placeholder="密码" class="border p-2 w-full mb-3 rounded">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="login()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded transition-colors">
                        <i class="fa fa-sign-in mr-1"></i>登录
                    </button>
                    <button onclick="register()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded transition-colors">
                        <i class="fa fa-user-plus mr-1"></i>注册
                    </button>
                </div>
                <p id="authMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            </div>
        </div>

        <!-- 接口管理区域（默认隐藏） -->
        <div id="apiArea" class="hidden">
            <!-- 添加接口 -->
            <div class="bg-white p-6 rounded shadow mb-6">
                <h3 class="font-bold mb-4 flex items-center">
                    <i class="fa fa-plus-circle text-green-500 mr-2"></i>添加新接口
                </h3>
                <input type="text" id="apiName" placeholder="接口名称（如：高清影视）" class="border p-2 w-full mb-3 rounded">
                <input type="url" id="apiUrl" placeholder="接口URL（如：https://example.com/api.json）" class="border p-2 w-full mb-3 rounded">
                <button onclick="addApi()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded transition-colors">
                    <i class="fa fa-save mr-1"></i>保存接口
                </button>
            </div>

            <!-- 接口列表 -->
            <div class="bg-white rounded shadow mb-6">
                <h3 class="font-bold p-4 border-b flex items-center">
                    <i class="fa fa-list text-blue-500 mr-2"></i>我的接口列表
                </h3>
                <div id="apiList" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fa fa-folder-open-o text-4xl mb-2 opacity-30"></i>
                        <p>暂无接口，请添加</p>
                    </div>
                </div>
            </div>

            <!-- 我的JSON地址 -->
            <div class="p-4 bg-blue-50 rounded border-l-4 border-blue-500">
                <h4 class="font-medium mb-2 flex items-center">
                    <i class="fa fa-external-link text-blue-600 mr-2"></i>我的聚合接口地址
                </h4>
                <p id="jsonUrl" class="break-all text-sm"></p>
                <button onclick="copyJsonUrl()" class="mt-2 text-blue-600 text-sm hover:underline">
                    <i class="fa fa-copy mr-1"></i>复制地址
                </button>
            </div>
        </div>
    </main>

    <!-- 通知提示 -->
    <div id="notify" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow transform translate-y-20 opacity-0 transition-all duration-300">
        <i id="notifyIcon" class="fa fa-check-circle mr-1"></i>
        <span id="notifyText"></span>
    </div>

    <script>
        // 检查登录状态
        document.addEventListener('DOMContentLoaded', checkLogin);

        // 登录功能
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('用户名和密码不能为空');
                return;
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    checkLogin();
                    showNotify('登录成功', 'check-circle', 'green');
                } else {
                    showMessage('用户名或密码错误');
                }
            } catch (e) {
                showMessage('登录失败，请重试');
            }
        }

        // 注册功能
        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('用户名和密码不能为空');
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (res.ok) {
                    showNotify('注册成功，请登录', 'check-circle', 'green');
                } else {
                    showMessage('注册失败，用户名可能已存在');
                }
            } catch (e) {
                showMessage('注册失败，请重试');
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('token');
            checkLogin();
            showNotify('已退出登录', 'sign-out', 'blue');
        }

        // 检查登录状态
        async function checkLogin() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const res = await fetch('/api/me', {
                        headers: { 'Authorization': token }
                    });
                    
                    if (res.ok) {
                        const user = await res.json();
                        // 显示接口管理区域
                        document.getElementById('authArea').classList.add('hidden');
                        document.getElementById('apiArea').classList.remove('hidden');
                        document.getElementById('userInfo').innerHTML = `欢迎，${user.username} <button id="logoutBtn" class="text-red-500 ml-4" onclick="logout()"><i class="fa fa-sign-out mr-1"></i>退出</button>`;
                        document.getElementById('jsonUrl').innerText = `${window.location.origin}/api/json?user=${user.id}`;
                        loadApis();
                        return;
                    }
                } catch (e) { /* 令牌无效 */ }
            }
            // 未登录状态
            document.getElementById('authArea').classList.remove('hidden');
            document.getElementById('apiArea').classList.add('hidden');
            document.getElementById('userInfo').innerHTML = '';
        }

        // 加载接口列表
        async function loadApis() {
            try {
                const res = await fetch('/api/apis', {
                    headers: { 'Authorization': localStorage.getItem('token') }
                });
                
                if (res.ok) {
                    const apis = await res.json();
                    const list = document.getElementById('apiList');
                    
                    if (apis.length === 0) {
                        list.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i class="fa fa-folder-open-o text-4xl mb-2 opacity-30"></i>
                                <p>暂无接口，请添加</p>
                            </div>
                        `;
                        return;
                    }
                    
                    list.innerHTML = apis.map(api => `
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 border-b last:border-0 hover:bg-gray-50">
                            <div>
                                <div class="font-medium">${escapeHtml(api.name)}</div>
                                <div class="text-sm text-gray-500 break-all mt-1">${escapeHtml(api.url)}</div>
                            </div>
                            <button onclick="deleteApi(${api.id})" class="text-red-500 hover:text-red-700 mt-2 sm:mt-0 transition-colors">
                                <i class="fa fa-trash mr-1"></i>删除
                            </button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                showNotify('加载接口失败', 'exclamation-circle', 'red');
            }
        }

        // 添加接口
        async function addApi() {
            const name = document.getElementById('apiName').value.trim();
            const url = document.getElementById('apiUrl').value.trim();
            
            if (!name || !url) {
                showNotify('名称和URL不能为空', 'exclamation-circle', 'red');
                return;
            }

            try {
                const res = await fetch('/api/apis', {
                    method: 'POST',
                    headers: { 
                        'Authorization': localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, url })
                });
                
                if (res.ok) {
                    document.getElementById('apiName').value = '';
                    document.getElementById('apiUrl').value = '';
                    loadApis();
                    showNotify('接口添加成功', 'check-circle', 'green');
                }
            } catch (e) {
                showNotify('添加接口失败', 'exclamation-circle', 'red');
            }
        }

        // 删除接口
        async function deleteApi(id) {
            if (!confirm('确定要删除这个接口吗？')) return;
            
            try {
                const res = await fetch(`/api/apis?id=${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': localStorage.getItem('token') }
                });
                
                if (res.ok) {
                    loadApis();
                    showNotify('接口已删除', 'trash', 'red');
                }
            } catch (e) {
                showNotify('删除接口失败', 'exclamation-circle', 'red');
            }
        }

        // 复制JSON地址
        function copyJsonUrl() {
            const url = document.getElementById('jsonUrl').innerText;
            navigator.clipboard.writeText(url);
            showNotify('地址已复制', 'copy', 'blue');
        }

        // 显示认证消息
        function showMessage(text) {
            const elem = document.getElementById('authMessage');
            elem.innerText = text;
            elem.classList.remove('hidden');
            setTimeout(() => elem.classList.add('hidden'), 3000);
        }

        // 显示通知
        function showNotify(text, icon, color) {
            const notify = document.getElementById('notify');
            const notifyText = document.getElementById('notifyText');
            const notifyIcon = document.getElementById('notifyIcon');
            
            notifyText.textContent = text;
            notifyIcon.className = `fa fa-${icon} mr-1`;
            notifyIcon.style.color = color === 'green' ? '#10B981' : 
                                   color === 'red' ? '#EF4444' : '#3B82F6';
            
            notify.classList.remove('translate-y-20', 'opacity-0');
            notify.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                notify.classList.remove('translate-y-0', 'opacity-100');
                notify.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // XSS过滤
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
    